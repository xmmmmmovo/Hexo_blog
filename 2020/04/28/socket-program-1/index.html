<!DOCTYPE html><html><head><script src="https://cdn.staticfile.org/echarts/4.8.0/echarts.min.js"></script><meta charset="utf-8"><title>网络编程笔记(1)---TCP与ECHO服务器 - 异国迷宫的十字路口</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#3F51B5"><meta name="keywords" content="c++,socket"><meta name="description" content="本文主要是在Linux环境下编写socket程序，本次实现简单TCPserver和client以及echo server和echo client"><meta property="og:type" content="article"><meta property="og:title" content="网络编程笔记(1)---TCP与ECHO服务器"><meta property="og:url" content="http://blog.fivezha.cn/2020/04/28/socket-program-1/index.html"><meta property="og:site_name" content="异国迷宫的十字路口"><meta property="og:description" content="本文主要是在Linux环境下编写socket程序，本次实现简单TCPserver和client以及echo server和echo client"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588078116060-f05e42c3-f202-4d5b-9710-2db2b576c66d.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588078284676-ab9b2ed5-f0ef-4478-aaa2-9a4c24f8ca26.webp"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588078349220-34006021-21e7-47be-b4f8-63baed9382b6.webp"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588118202067-721fb73c-2732-4490-9e74-44e63ba46647.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588118218855-6ed39004-f673-4193-a505-71db6c9a7026.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588118218855-6ed39004-f673-4193-a505-71db6c9a7026.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588118553490-5f00c550-3323-4f3f-a659-99c18b66dff7.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588118710732-9129da97-e3e2-49bd-a781-58c2fe7e0411.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588119669498-7a97fde3-258f-47a8-a7df-b62090f44225.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588124291436-8a2614f1-7e31-4d77-9fde-66cb601dde05.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588124419227-9e3b102c-99dd-4997-a1a9-078da7a3f9b4.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588134607200-d385c7b4-742b-4d3b-a2c8-0c1d39bf9908.png"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/1337142/1588134657937-d32ccb9f-edae-4abb-8d0c-7add2b93172f.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588134673711-34e815b2-b9fc-4578-9a8c-74887b8b3459.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588134555033-16c67e97-f1d0-4c11-9306-45a335eb7672.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588135167103-c016147f-80ed-40ec-83d1-3723b6d22518.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588135244153-85f9620d-3f95-4c35-9c83-d89022984acc.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588138094808-4c630103-94cb-4688-9c1b-7296217a99ca.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588138363087-01c3e48a-226b-4699-a0d4-649fd7c6a53b.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588164592478-804b3536-f534-4622-bd7c-40a15e7886bf.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588164562852-3e156431-c24a-49c8-b4c0-5b0900c4d368.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588164525052-62e2c390-1840-462d-aee2-2a8c4c7efb34.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588164514314-182083c4-11ca-49cd-aad0-39b7c1c1a2cc.png"><meta property="article:published_time" content="2020-04-28T12:39:26.000Z"><meta property="article:modified_time" content="2020-07-26T12:36:39.153Z"><meta property="article:author" content="xmmmmmovo"><meta property="article:tag" content="c++"><meta property="article:tag" content="socket"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588078116060-f05e42c3-f202-4d5b-9710-2db2b576c66d.png"><link rel="alternate" type="application/atom+xml" title="异国迷宫的十字路口" href="/atom.xml"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/xmmmmmovo/indigomod/dist/css/style.css"><script>window.lazyScripts=[]</script><script>var _mtac={};!function(){var t=document.createElement("script");t.src="//pingjs.qq.com/h5/stats.js?v2.0.4",t.setAttribute("name","MTAH5"),t.setAttribute("sid","500725321");var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()</script><meta name="generator" content="Hexo 4.2.1"></head><body><div id="loading" class="active"></div><aside id="menu"><div class="inner flex-row-vertical"><a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off"><i class="icon icon-lg icon-close"></i></a><div class="brand-wrap" style="background-image:url(/img/brand.png)"><div class="brand"> <a href="/" class="avatar waves-effect waves-circle waves-light"><img src="/img/avatar.png"></a><hgroup class="introduce"><h5 class="nickname">xmmmmmovo</h5> <a href="mailto:lolicoin@foxmail.com" title="lolicoin@foxmail.com" class="mail">lolicoin@foxmail.com</a></hgroup></div></div><div class="scroll-wrap flex-col"><ul class="nav"><li class="waves-block waves-effect"><a href="/"><i class="icon icon-lg icon-home"></i> 主页</a></li><li class="waves-block waves-effect"><a href="/archives"><i class="icon icon-lg icon-archives"></i> 归档</a></li><li class="waves-block waves-effect"><a href="/tags"><i class="icon icon-lg icon-tags"></i> Tags</a></li><li class="waves-block waves-effect"><a href="/categories"><i class="icon icon-lg icon-th-list"></i> 分类</a></li><li class="waves-block waves-effect"><a href="/about"><i class="icon icon-lg icon-user"></i> 关于</a></li><li class="waves-block waves-effect"><a href="/links"><i class="icon icon-lg icon-external-link"></i> 友链</a></li><li class="waves-block waves-effect"><a href="https://github.com/xmmmmmovo" target="_blank"><i class="icon icon-lg icon-github"></i> Github</a></li><li class="waves-block waves-effect"><a href="https://travellings.now.sh/" target="_blank"><i class="icon icon-lg icon-paper-plane"></i> 开往~新世界~</a></li></ul></div></div></aside><main id="main"><header class="top-header" id="header"><div class="flex-row"><a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle"><i class="icon icon-lg icon-navicon"></i></a><div class="flex-col header-title ellipsis">网络编程笔记(1)---TCP与ECHO服务器</div><div class="search-wrap" id="search-wrap"><a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back"><i class="icon icon-lg icon-chevron-left"></i></a> <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字"><a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search"><i class="icon icon-lg icon-search"></i></a></div><a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare"><i class="icon icon-lg icon-share-alt"></i></a></div></header><header class="content-header post-header"><div class="container fade-scale"><h1 class="title">网络编程笔记(1)---TCP与ECHO服务器</h1><h5 class="subtitle"> <time datetime="2020-04-28T12:39:26.000Z" itemprop="datePublished" class="page-time">2020-04-28</time><ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/assignment/">assignment</a></li></ul></h5></div></header><div class="container body-wrap"><aside class="post-widget"><nav class="post-toc-wrap post-toc-shrink" id="post-toc"><h4>TOC</h4><ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#什么是Socket"><span class="post-toc-number">1.</span> <span class="post-toc-text">什么是Socket</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#为什么会有Socket"><span class="post-toc-number">2.</span> <span class="post-toc-text">为什么会有Socket</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#学习Linux-下的网络编程-socket编程"><span class="post-toc-number">3.</span> <span class="post-toc-text">学习Linux 下的网络编程(socket编程)</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#创建套接字"><span class="post-toc-number">3.0.1.</span> <span class="post-toc-text">创建套接字</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#文件描述符-windows下称之为句柄"><span class="post-toc-number">3.0.1.1.</span> <span class="post-toc-text">文件描述符(windows下称之为句柄):</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#协议簇"><span class="post-toc-number">3.0.1.2.</span> <span class="post-toc-text">协议簇:</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#套接字类型"><span class="post-toc-number">3.0.1.3.</span> <span class="post-toc-text">套接字类型:</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#协议"><span class="post-toc-number">3.0.1.4.</span> <span class="post-toc-text">协议</span></a></li></ol></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#sockaddr-in"><span class="post-toc-number">3.0.2.</span> <span class="post-toc-text">sockaddr_in</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#网络字节序"><span class="post-toc-number">3.0.3.</span> <span class="post-toc-text">网络字节序</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#TCPserver-clien"><span class="post-toc-number">3.0.4.</span> <span class="post-toc-text">TCPserver&#x2F;clien</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#accept"><span class="post-toc-number">3.0.4.1.</span> <span class="post-toc-text">accept()</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#connect"><span class="post-toc-number">3.0.4.2.</span> <span class="post-toc-text">connect()</span></a></li></ol></li></ol></li></ol><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#实现简单的server-client"><span class="post-toc-number">4.</span> <span class="post-toc-text">实现简单的server&#x2F;client</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Server"><span class="post-toc-number">4.1.</span> <span class="post-toc-text">Server</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#client"><span class="post-toc-number">4.2.</span> <span class="post-toc-text">client</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#结果"><span class="post-toc-number">4.3.</span> <span class="post-toc-text">结果</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#实现echo服务器"><span class="post-toc-number">5.</span> <span class="post-toc-text">实现echo服务器</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Server-1"><span class="post-toc-number">5.1.</span> <span class="post-toc-text">Server</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Client"><span class="post-toc-number">5.2.</span> <span class="post-toc-text">Client</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#结果-1"><span class="post-toc-number">5.3.</span> <span class="post-toc-text">结果</span></a></li></ol></li></nav></aside><article id="post-socket-program-1" class="post-article article-type-post fade" itemprop="blogPost"><div class="post-card"><h1 class="post-card-title">网络编程笔记(1)---TCP与ECHO服务器</h1><div class="post-meta"><time class="post-time" title="2020-04-28 20:39:26" datetime="2020-04-28T12:39:26.000Z" itemprop="datePublished"><i class="icon icon-calendar"></i> 2020-04-28</time><ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/assignment/">assignment</a></li></ul><span id="busuanzi_container_page_pv" title="文章总阅读量" style="display:none"><i class="icon icon-eye" style="padding:0 .3em"></i><span id="busuanzi_value_page_pv"></span></span></div><div class="post-content" id="post-content" itemprop="postContent"><p>本文主要是在<code>Linux</code>环境下编写<code>socket</code>程序，本次实现简单TCP<code>server</code>和<code>client</code>以及<code>echo server</code>和<code>echo client</code><a id="more"></a></p><h2 id="什么是Socket"><a href="#什么是Socket" class="headerlink" title="什么是Socket"></a>什么是Socket</h2><p>Socket中文译名套接字, 是一个当时没有在计网中讲到的知识, 但确实是极其重要的一个知识点, 他是基于TCP/IP协议的封装抽象层, 它对于TCP协议进行了封装, 使得其现在已经成为了最为通用的网络通信接口/应用程序接口.<br>关于TCP协议可以看下面这篇文章</p><p><a href="https://tools.ietf.org/html/rfc793" target="_blank" rel="noopener">https://tools.ietf.org/html/rfc793</a></p><h2 id="为什么会有Socket"><a href="#为什么会有Socket" class="headerlink" title="为什么会有Socket"></a>为什么会有Socket</h2><p>我们知道, 服务/服务器其实是有很大可能不存在于一个计算机上的, 这就有了客户端与服务端, 在服务器之间, 也是需要存在连接通信的, 所以需要有一个用于进行通信的通用 <strong>可编程</strong> 接口, 这就是socket, 他对于 <code>server</code> 和 <code>client</code> 之间架起了一道桥, 让 <code>server</code> 与 <code>port</code> 绑定, 让 <code>client</code> 与 <code>ip:port</code> 连接, 这样就相当于 <code>client</code> 进程与 <code>server</code> 进程之间有了像是管道一样的通信, 不过这个通信是全双工的.</p><figure class="image-bubble"><div class="img-lightbox"><div class="overlay"></div> <img src="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588078116060-f05e42c3-f202-4d5b-9710-2db2b576c66d.png" alt="img" title=""></div><div class="image-caption">img</div></figure><p>我们回顾TCP状态转换图</p><figure class="image-bubble"><div class="img-lightbox"><div class="overlay"></div> <img src="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588078284676-ab9b2ed5-f0ef-4478-aaa2-9a4c24f8ca26.webp" alt="img" title=""></div><div class="image-caption">img</div></figure><p>在这里能够找到许多socket封装的影子, 从客户端来看</p><figure class="image-bubble"><div class="img-lightbox"><div class="overlay"></div> <img src="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588078349220-34006021-21e7-47be-b4f8-63baed9382b6.webp" alt="img" title=""></div><div class="image-caption">img</div></figure><p>则更加明显</p><h2 id="学习Linux-下的网络编程-socket编程"><a href="#学习Linux-下的网络编程-socket编程" class="headerlink" title="学习Linux 下的网络编程(socket编程)"></a>学习Linux 下的网络编程(socket编程)</h2><h4 id="创建套接字"><a href="#创建套接字" class="headerlink" title="创建套接字"></a>创建套接字</h4><blockquote><p>int socket(int domain, int type, int protocol)<br>return : 文件描述符 / or not -1<br>domain: 套接字所使用的协议簇<br>type: 套接字数据传输类型<br>protocol: 套接字所使用的协议</p></blockquote><h5 id="文件描述符-windows下称之为句柄"><a href="#文件描述符-windows下称之为句柄" class="headerlink" title="文件描述符(windows下称之为句柄):"></a>文件描述符(windows下称之为句柄):</h5><p>系统分配给文件或套接字的一个整数:</p><figure class="image-bubble"><div class="img-lightbox"><div class="overlay"></div> <img src="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588118202067-721fb73c-2732-4490-9e74-44e63ba46647.png" alt="img" title=""></div><div class="image-caption">img</div></figure><p><a href="https://segmentfault.com/a/1190000009724931" target="_blank" rel="noopener">https://segmentfault.com/a/1190000009724931</a></p><figure class="image-bubble"><div class="img-lightbox"><div class="overlay"></div> <img src="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588118218855-6ed39004-f673-4193-a505-71db6c9a7026.png" alt="img" title=""></div><div class="image-caption">img</div></figure><h5 id="协议簇"><a href="#协议簇" class="headerlink" title="协议簇:"></a>协议簇:</h5><figure class="image-bubble"><div class="img-lightbox"><div class="overlay"></div> <img src="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588118218855-6ed39004-f673-4193-a505-71db6c9a7026.png" alt="img" title=""></div><div class="image-caption">img</div></figure><h5 id="套接字类型"><a href="#套接字类型" class="headerlink" title="套接字类型:"></a>套接字类型:</h5><ol><li>SOCK_STREAM(流式)(面向连接)<figure class="image-bubble"><div class="img-lightbox"><div class="overlay"></div> <img src="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588118553490-5f00c550-3323-4f3f-a659-99c18b66dff7.png" alt="img" title=""></div><div class="image-caption">img</div></figure></li><li>SOCK_DGRAM(包式)(面向消息)<figure class="image-bubble"><div class="img-lightbox"><div class="overlay"></div> <img src="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588118710732-9129da97-e3e2-49bd-a781-58c2fe7e0411.png" alt="img" title=""></div><div class="image-caption">img</div></figure></li></ol><h5 id="协议"><a href="#协议" class="headerlink" title="协议"></a>协议</h5><figure class="image-bubble"><div class="img-lightbox"><div class="overlay"></div> <img src="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588119669498-7a97fde3-258f-47a8-a7df-b62090f44225.png" alt="img" title=""></div><div class="image-caption">img</div></figure><h4 id="sockaddr-in"><a href="#sockaddr-in" class="headerlink" title="sockaddr_in"></a>sockaddr_in</h4><figure class="image-bubble"><div class="img-lightbox"><div class="overlay"></div> <img src="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588124291436-8a2614f1-7e31-4d77-9fde-66cb601dde05.png" alt="img" title=""></div><div class="image-caption">img</div></figure><figure class="image-bubble"><div class="img-lightbox"><div class="overlay"></div> <img src="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588124419227-9e3b102c-99dd-4997-a1a9-078da7a3f9b4.png" alt="img" title=""></div><div class="image-caption">img</div></figure><h4 id="网络字节序"><a href="#网络字节序" class="headerlink" title="网络字节序"></a>网络字节序</h4><figure class="image-bubble"><div class="img-lightbox"><div class="overlay"></div> <img src="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588134607200-d385c7b4-742b-4d3b-a2c8-0c1d39bf9908.png" alt="img" title=""></div><div class="image-caption">img</div></figure><p>IntelCPU默认都是小端序, 而网络连接统一都是大端序</p><figure class="image-bubble"><div class="img-lightbox"><div class="overlay"></div> <img src="https://cdn.nlark.com/yuque/0/2020/png/1337142/1588134657937-d32ccb9f-edae-4abb-8d0c-7add2b93172f.png" alt="img" title=""></div><div class="image-caption">img</div></figure><figure class="image-bubble"><div class="img-lightbox"><div class="overlay"></div> <img src="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588134673711-34e815b2-b9fc-4578-9a8c-74887b8b3459.png" alt="img" title=""></div><div class="image-caption">img</div></figure><h4 id="TCPserver-clien"><a href="#TCPserver-clien" class="headerlink" title="TCPserver/clien"></a>TCPserver/clien</h4><figure class="image-bubble"><div class="img-lightbox"><div class="overlay"></div> <img src="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588134555033-16c67e97-f1d0-4c11-9306-45a335eb7672.png" alt="img" title=""></div><div class="image-caption">img</div></figure><figure class="image-bubble"><div class="img-lightbox"><div class="overlay"></div> <img src="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588135167103-c016147f-80ed-40ec-83d1-3723b6d22518.png" alt="img" title=""></div><div class="image-caption">img</div></figure><p>所以又回到了最最上面的第一个图:</p><figure class="image-bubble"><div class="img-lightbox"><div class="overlay"></div> <img src="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588135244153-85f9620d-3f95-4c35-9c83-d89022984acc.png" alt="img" title=""></div><div class="image-caption">img</div></figure><h5 id="accept"><a href="#accept" class="headerlink" title="accept()"></a>accept()</h5><figure class="image-bubble"><div class="img-lightbox"><div class="overlay"></div> <img src="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588138094808-4c630103-94cb-4688-9c1b-7296217a99ca.png" alt="img" title=""></div><div class="image-caption">img</div></figure><p>sock: 利用socket()函数建立的sock<br>addr: 地址变量<br>addlen: 结构体长度</p><h5 id="connect"><a href="#connect" class="headerlink" title="connect()"></a>connect()</h5><figure class="image-bubble"><div class="img-lightbox"><div class="overlay"></div> <img src="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588138363087-01c3e48a-226b-4699-a0d4-649fd7c6a53b.png" alt="img" title=""></div><div class="image-caption">img</div></figure><h2 id="实现简单的server-client"><a href="#实现简单的server-client" class="headerlink" title="实现简单的server/client"></a>实现简单的server/client</h2><h3 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by xmmmmmovo on 2020/4/16.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">string</span>;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::to_string;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">error_handler</span><span class="params">(<span class="keyword">char</span> *message)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> serv_sock, clnt_sock;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serv_addr</span> &#123;</span>&#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">clnt_addr</span> &#123;</span>&#125;;</span><br><span class="line">    <span class="keyword">socklen_t</span> clnt_addr_size;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">string</span> message = <span class="string">"Hello World!"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Usage : %s &lt;port&gt;\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    serv_sock = socket(PF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (serv_sock == <span class="number">-1</span>) &#123;</span><br><span class="line">        error_handler(<span class="string">"socket() error"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;serv_addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(serv_addr));<span class="comment">// 初始化内存</span></span><br><span class="line"></span><br><span class="line">    serv_addr.sin_family = AF_INET;</span><br><span class="line">    serv_addr.sin_addr.s_addr = htonl(INADDR_ANY);<span class="comment">// 当前主机ip</span></span><br><span class="line">    serv_addr.sin_port = htons(atoi(argv[<span class="number">1</span>]));</span><br><span class="line">    <span class="keyword">if</span> (bind(serv_sock, (struct sockaddr *) &amp;serv_addr, <span class="keyword">sizeof</span>(serv_addr)) == <span class="number">-1</span>) &#123;</span><br><span class="line">        error_handler(<span class="string">"bind() error"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (listen(serv_sock, <span class="number">5</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">        error_handler(<span class="string">"listen() error"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    clnt_addr_size = <span class="keyword">sizeof</span>(clnt_addr);</span><br><span class="line">    clnt_sock = accept(serv_sock, (struct sockaddr *) &amp;clnt_addr, &amp;clnt_addr_size);</span><br><span class="line">    <span class="keyword">if</span> (clnt_sock == <span class="number">-1</span>) &#123;</span><br><span class="line">        error_handler(<span class="string">"accept() error"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; <span class="number">4</span>; ++i) &#123;</span><br><span class="line">        sleep(rand() % <span class="number">2</span>);</span><br><span class="line">        <span class="built_in">string</span> tmp = message + to_string(i);</span><br><span class="line">        write(clnt_sock, tmp.c_str(), tmp.size());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// write(clnt_sock, message.c_str(), message.size());// 连接之后直接向client写入数据</span></span><br><span class="line">    close(clnt_sock);</span><br><span class="line">    close(serv_sock);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">error_handler</span><span class="params">(<span class="keyword">char</span> *message)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">fputs</span>(message, <span class="built_in">stderr</span>);</span><br><span class="line">    fputc(<span class="string">'\n'</span>, <span class="built_in">stderr</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="client"><a href="#client" class="headerlink" title="client"></a>client</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by xmmmmmovo on 2020/4/16.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">error_handler</span><span class="params">(<span class="keyword">char</span> *messgae)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sock;</span><br><span class="line">    sockaddr_in serv_addr&#123;&#125;;</span><br><span class="line">    <span class="keyword">int</span> str_len = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> idx = <span class="number">0</span>, read_len = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">string</span> message;<span class="comment">// 信息流</span></span><br><span class="line">    message.resize(<span class="number">100</span>, <span class="string">'\0'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Usage : %s &lt;IP&gt; &lt;port&gt;\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sock = socket(PF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (sock == <span class="number">-1</span>) &#123;</span><br><span class="line">        error_handler(<span class="string">"socket() error"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;serv_addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(serv_addr));</span><br><span class="line">    serv_addr.sin_family = AF_INET;</span><br><span class="line">    <span class="comment">// 这里会自动将ip字符串转换为uint32_t类型IP数字</span></span><br><span class="line">    serv_addr.sin_addr.s_addr = inet_addr(argv[<span class="number">1</span>]);</span><br><span class="line">    serv_addr.sin_port = htons(atoi(argv[<span class="number">2</span>]));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (connect(sock, (sockaddr *) &amp;serv_addr, <span class="keyword">sizeof</span>(serv_addr)) == <span class="number">-1</span>) &#123;</span><br><span class="line">        error_handler(<span class="string">"connect() error!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">bool</span> check = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 每次只读出一个字节</span></span><br><span class="line">    <span class="keyword">while</span> (read_len = read(sock, &amp;message[idx++], <span class="number">1</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (str_len == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (check)</span><br><span class="line">                error_handler(<span class="string">"read() error!"</span>);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                sleep(<span class="number">3</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        str_len += read_len;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Message from server is : %s \n"</span>, message.c_str());</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Function read call count : %d \n"</span>, str_len);</span><br><span class="line">    close(sock);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">error_handler</span><span class="params">(<span class="keyword">char</span> *message)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">fputs</span>(message, <span class="built_in">stderr</span>);</span><br><span class="line">    fputc(<span class="string">'\n'</span>, <span class="built_in">stderr</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h3><p>可以看到 <code>client</code> 成功接受到了流字符:</p><figure class="image-bubble"><div class="img-lightbox"><div class="overlay"></div> <img src="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588164592478-804b3536-f534-4622-bd7c-40a15e7886bf.png" alt="img" title=""></div><div class="image-caption">img</div></figure><p>同时 <code>server</code> 也发送成功结束了程序:</p><figure class="image-bubble"><div class="img-lightbox"><div class="overlay"></div> <img src="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588164562852-3e156431-c24a-49c8-b4c0-5b0900c4d368.png" alt="img" title=""></div><div class="image-caption">img</div></figure><h2 id="实现echo服务器"><a href="#实现echo服务器" class="headerlink" title="实现echo服务器"></a>实现echo服务器</h2><h3 id="Server-1"><a href="#Server-1" class="headerlink" title="Server"></a>Server</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by xmmmmmovo on 2020/4/16.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::stoi;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">string</span>;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::to_string;</span><br><span class="line"></span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">int</span> BUF_SIZE = <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">error_handler</span><span class="params">(<span class="keyword">char</span> *message)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> serv_sock, clnt_sock;</span><br><span class="line">    <span class="keyword">char</span> message[BUF_SIZE];</span><br><span class="line">    <span class="keyword">int</span> size_len = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">char</span> size_buf[size_len];</span><br><span class="line">    sockaddr_in serv_addr&#123;&#125;, clnt_addr&#123;&#125;;</span><br><span class="line">    <span class="keyword">socklen_t</span> clnt_addr_size;</span><br><span class="line">    <span class="keyword">int</span> str_len = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Usage : %s &lt;port&gt;\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    serv_sock = socket(PF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (serv_sock == <span class="number">-1</span>) &#123;</span><br><span class="line">        error_handler(<span class="string">"socket() error"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;serv_addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(serv_addr));<span class="comment">// 初始化内存</span></span><br><span class="line"></span><br><span class="line">    serv_addr.sin_family = AF_INET;</span><br><span class="line">    serv_addr.sin_addr.s_addr = htonl(INADDR_ANY);<span class="comment">// 当前主机ip</span></span><br><span class="line">    serv_addr.sin_port = htons(atoi(argv[<span class="number">1</span>]));</span><br><span class="line">    <span class="keyword">if</span> (bind(serv_sock, (struct sockaddr *) &amp;serv_addr, <span class="keyword">sizeof</span>(serv_addr)) == <span class="number">-1</span>) &#123;</span><br><span class="line">        error_handler(<span class="string">"bind() error"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (listen(serv_sock, <span class="number">5</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">        error_handler(<span class="string">"listen() error"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    clnt_addr_size = <span class="keyword">sizeof</span>(clnt_addr);<span class="comment">// 算长度</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">///主体</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; ++i) &#123;</span><br><span class="line">        clnt_sock = accept(serv_sock, (sockaddr *) &amp;clnt_addr, &amp;clnt_addr_size);</span><br><span class="line">        <span class="keyword">if</span> (clnt_sock == <span class="number">1</span>) &#123;</span><br><span class="line">            error_handler(<span class="string">"accept() error!"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Connected client %d \n"</span>, i + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((str_len = read(clnt_sock, size_buf, size_len)) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((str_len = read(clnt_sock, message, stoi(size_buf))) != <span class="number">0</span>) &#123;</span><br><span class="line">                    write(clnt_sock, size_buf, size_len);</span><br><span class="line">                    write(clnt_sock, message, str_len);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        close(clnt_sock);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">///</span></span><br><span class="line"></span><br><span class="line">    close(serv_sock);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">error_handler</span><span class="params">(<span class="keyword">char</span> *message)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">fputs</span>(message, <span class="built_in">stderr</span>);</span><br><span class="line">    fputc(<span class="string">'\n'</span>, <span class="built_in">stderr</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by xmmmmmovo on 2020/4/16.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::stoi;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">string</span>;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::to_string;</span><br><span class="line"></span><br><span class="line"><span class="keyword">constexpr</span> <span class="keyword">int</span> BUF_SIZE = <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">error_handler</span><span class="params">(<span class="keyword">char</span> *messgae)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sock;</span><br><span class="line">    sockaddr_in serv_addr&#123;&#125;;</span><br><span class="line">    <span class="keyword">int</span> str_len = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> message[BUF_SIZE];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Usage : %s &lt;IP&gt; &lt;port&gt;\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sock = socket(PF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (sock == <span class="number">-1</span>) &#123;</span><br><span class="line">        error_handler(<span class="string">"socket() error"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;serv_addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(serv_addr));</span><br><span class="line">    serv_addr.sin_family = AF_INET;</span><br><span class="line">    <span class="comment">// 这里会自动将ip字符串转换为uint32_t类型IP数字</span></span><br><span class="line">    serv_addr.sin_addr.s_addr = inet_addr(argv[<span class="number">1</span>]);</span><br><span class="line">    serv_addr.sin_port = htons(atoi(argv[<span class="number">2</span>]));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (connect(sock, (sockaddr *) &amp;serv_addr, <span class="keyword">sizeof</span>(serv_addr)) == <span class="number">-1</span>) &#123;</span><br><span class="line">        error_handler(<span class="string">"connect() error!"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"Connected......"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="built_in">fputs</span>(<span class="string">"Input message(Q/q to quit): "</span>, <span class="built_in">stdout</span>);</span><br><span class="line">        <span class="built_in">std</span>::fgets(message, BUF_SIZE, <span class="built_in">stdin</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(message, <span class="string">"q\n"</span>) || !<span class="built_in">strcmp</span>(message, <span class="string">"Q\n"</span>)) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> l = <span class="built_in">strlen</span>(message);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"len = %d\n"</span>, l);</span><br><span class="line">        <span class="built_in">string</span> s = to_string(l);</span><br><span class="line">        s.resize(<span class="number">4</span>);</span><br><span class="line">        write(sock, s.c_str(), <span class="number">4</span>);</span><br><span class="line">        write(sock, message, <span class="built_in">strlen</span>(message));</span><br><span class="line">        <span class="keyword">char</span> buf[<span class="number">4</span>];</span><br><span class="line">        str_len = read(sock, buf, <span class="number">4</span>);</span><br><span class="line">        str_len = read(sock, message, stoi(buf));</span><br><span class="line">        message[str_len] = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Message from server: %s\n"</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    close(sock);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">error_handler</span><span class="params">(<span class="keyword">char</span> *message)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">fputs</span>(message, <span class="built_in">stderr</span>);</span><br><span class="line">    fputc(<span class="string">'\n'</span>, <span class="built_in">stderr</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="结果-1"><a href="#结果-1" class="headerlink" title="结果"></a>结果</h3><p>client:</p><figure class="image-bubble"><div class="img-lightbox"><div class="overlay"></div> <img src="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588164525052-62e2c390-1840-462d-aee2-2a8c4c7efb34.png" alt="img" title=""></div><div class="image-caption">img</div></figure><p>server:</p><figure class="image-bubble"><div class="img-lightbox"><div class="overlay"></div> <img src="https://cdn.jsdelivr.net/gh/xmmmmmovo/ResourcesBackup/blog/pics/1588164514314-182083c4-11ca-49cd-aad0-39b7c1c1a2cc.png" alt="img" title=""></div><div class="image-caption">img</div></figure></div><blockquote class="post-copyright"><div class="content"> <span class="post-time">最后更新时间：<time datetime="2020-07-26T12:36:39.153Z" itemprop="dateUpdated">2020-07-26 20:36:39</time></span><br> 如非注明转载，均为本文原创或编译，转载请注明出处。<br>本文链接：<a href="/2020/04/28/socket-program-1/" target="_blank" rel="external">http://blog.fivezha.cn/2020/04/28/socket-program-1/</a><br>本文遵循<a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></div><footer> <a href="http://blog.fivezha.cn"><img src="/img/avatar.png" alt="xmmmmmovo"> xmmmmmovo</a></footer></blockquote><div class="page-reward"> <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a></div><div class="post-footer"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/c/" rel="tag">c++</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/socket/" rel="tag">socket</a></li></ul><div class="page-share-wrap"><div class="page-share" id="pageShare"><ul class="reset share-icons"><li><a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://blog.fivezha.cn/2020/04/28/socket-program-1/&title=《网络编程笔记(1)---TCP与ECHO服务器》 — 异国迷宫的十字路口&pic=http://blog.fivezha.cn/img/avatar.png" data-title="微博"><i class="icon icon-weibo"></i></a></li><li><a class="weixin share-sns wxFab" href="javascript:;" data-title="微信"><i class="icon icon-weixin"></i></a></li><li><a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://blog.fivezha.cn/2020/04/28/socket-program-1/&title=《网络编程笔记(1)---TCP与ECHO服务器》 — 异国迷宫的十字路口&source=本文主要是在Linux环境下编写socket程序，本次实现简单TCPserver和client以及echo server和echo client" data-title=" QQ"><i class="icon icon-qq"></i></a></li><li><a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://blog.fivezha.cn/2020/04/28/socket-program-1/" data-title=" Facebook"><i class="icon icon-facebook"></i></a></li><li><a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《网络编程笔记(1)---TCP与ECHO服务器》 — 异国迷宫的十字路口&url=http://blog.fivezha.cn/2020/04/28/socket-program-1/&via=http://blog.fivezha.cn" data-title=" Twitter"><i class="icon icon-twitter"></i></a></li><li><a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://blog.fivezha.cn/2020/04/28/socket-program-1/" data-title=" Google+"><i class="icon icon-google-plus"></i></a></li></ul></div><a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle"><i class="icon icon-share-alt icon-lg"></i></a></div></div></div><nav class="post-nav flex-row flex-justify-between"><div class="waves-block waves-effect prev"><a href="/2020/04/29/socket-program-2/" id="post-prev" class="post-nav-link"><div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div><h4 class="title">网络编程笔记(2)---UDP与分包协议</h4></a></div><div class="waves-block waves-effect next"><a href="/2020/04/24/docker-note/" id="post-next" class="post-nav-link"><div class="tips">Next<i class="icon icon-angle-right icon-lg icon-pl"></i></div><h4 class="title">docker笔记</h4></a></div></nav><div class="comments vcomment" id="comments"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var GUEST_INFO=["nick","mail","link"],guest_info="昵称,邮箱,网址(https://)".split(",").filter(function(e){return-1<GUEST_INFO.indexOf(e)});new Valine({el:"#comments",notify:!0,verify:!1,appId:"55ujxYDQhAADDjyqYIwt1e1e-gzGzoHsz",appKey:"F1sOiWvmQ6AJvItQoKMKFFEd",avatar:"mp",placeholder:"有什么想法都可以写昂~",guest_info:0==guest_info.length?GUEST_INFO:guest_info,pageSize:"15"})</script></article><div id="reward" class="page-modal reward-lay"><a class="close" href="javascript:;"><i class="icon icon-close"></i></a><h3 class="reward-title"><i class="icon icon-quote-left"></i> 感恩亲人~<i class="icon icon-quote-right"></i></h3><div class="reward-content"><div class="reward-code"> <img id="rewardCode" src="/img/wechat.png" alt="打赏二维码"></div> <label class="reward-toggle"><input id="rewardToggle" type="checkbox" class="reward-toggle-check" data-wechat="/img/wechat.png" data-alipay="/img/alipay.png"><div class="reward-toggle-ctrol"> <span class="reward-toggle-item wechat">微信</span> <span class="reward-toggle-item switch" id="switvh">切换</span> <span class="reward-toggle-item alipay">支付宝</span></div></label></div></div><script src="//unpkg.com/jquery@latest/dist/jquery.min.js"></script><script src="//cdn.jsdelivr.net/gh/xmmmmmovo/indigomod/dist/js/clipboard.min.js"></script><script src="//cdn.jsdelivr.net/gh/xmmmmmovo/indigomod/dist/js/copy.min.js"></script></div><footer class="footer"><div class="top"><p> <span id="busuanzi_container_site_uv" style="display:none">站点总访客数：<span id="busuanzi_value_site_uv"></span></span> <span id="busuanzi_container_site_pv" style="display:none">站点总访问量：<span id="busuanzi_value_site_pv"></span></span></p><p> <span>xmmmmmovo &copy; 2017 - 2020</span> <span><a href="http://beian.miit.gov.cn/" target="_blank">鲁ICP备20025683号-1</a><br> Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/ivitan/indigo" target="_blank">Indigo</a></span></p></div><div class="bottom"><p><span><a href="/atom.xml" target="_blank" class="rss" title="RSS"><i class="icon icon-lg icon-rss"></i></a></span> <span>内容遵循 <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享 署名 - 非商业性 - 相同方式共享 4.0 协议</a></span></p></div></footer></main><div class="mask" id="mask"></div><a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a><div class="global-share" id="globalShare"><ul class="reset share-icons"><li><a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://blog.fivezha.cn/2020/04/28/socket-program-1/&title=《网络编程笔记(1)---TCP与ECHO服务器》 — 异国迷宫的十字路口&pic=http://blog.fivezha.cn/img/avatar.png" data-title="微博"><i class="icon icon-weibo"></i></a></li><li><a class="weixin share-sns wxFab" href="javascript:;" data-title="微信"><i class="icon icon-weixin"></i></a></li><li><a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://blog.fivezha.cn/2020/04/28/socket-program-1/&title=《网络编程笔记(1)---TCP与ECHO服务器》 — 异国迷宫的十字路口&source=本文主要是在Linux环境下编写socket程序，本次实现简单TCPserver和client以及echo server和echo client" data-title=" QQ"><i class="icon icon-qq"></i></a></li><li><a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://blog.fivezha.cn/2020/04/28/socket-program-1/" data-title=" Facebook"><i class="icon icon-facebook"></i></a></li><li><a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《网络编程笔记(1)---TCP与ECHO服务器》 — 异国迷宫的十字路口&url=http://blog.fivezha.cn/2020/04/28/socket-program-1/&via=http://blog.fivezha.cn" data-title=" Twitter"><i class="icon icon-twitter"></i></a></li><li><a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://blog.fivezha.cn/2020/04/28/socket-program-1/" data-title=" Google+"><i class="icon icon-google-plus"></i></a></li></ul></div><div class="page-modal wx-share" id="wxShare"><a class="close" href="javascript:;"><i class="icon icon-close"></i></a><p>扫一扫，分享到微信</p> <img src="//api.qrserver.com/v1/create-qr-code/?data=http://blog.fivezha.cn/2020/04/28/socket-program-1/" alt="微信分享二维码"></div><script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script><script>var BLOG={ROOT:"/",SHARE:!0,REWARD:!0}</script><script src="//cdn.jsdelivr.net/gh/xmmmmmovo/indigomod/dist/js/main.min.js"></script><div class="search-panel" id="search-panel"><ul class="search-result" id="search-result"></ul></div><template id="search-tpl"><li class="item"><a href="{path}" class="waves-block waves-effect"><div class="title ellipsis" title="{title}">{title}</div><div class="flex-row flex-middle"><div class="tags ellipsis"> {tags}</div> <time class="flex-col time">{date}</time></div></a></li></template><script src="//cdn.jsdelivr.net/gh/xmmmmmovo/indigomod/dist/js/search.min.js" async></script><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" async></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>